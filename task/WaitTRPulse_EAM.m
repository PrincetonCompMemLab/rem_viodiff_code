function varargout = WaitTRPulse_EAM(timeToWait,DEVICE)global deburgrecorded = false;secs = -1;loop_delay = .0005;%trigger_key = 34; % KbName('5%')trigger_key = 46; % KbName('=+')TRlength = 1.5;if ~exist('timeToWait', 'var')    timeToWait = inf;endKbQueueFlush(DEVICE); %flushes buffer so only response after this point are recordedwhile (GetSecs<timeToWait)    WaitSecs(loop_delay);    if timeToWait < inf % if set a time, make sure it's within 1 TR        if GetSecs > timeToWait - (TRlength - TRlength/2) %only look if within a TR                        %[keyIsDown,secs,keyCode] = KbCheck(DEVICE);            %             if (keyIsDown)            %                 if (keyCode(trigger_key))            %                     recorded = true;            %                     break;                        [pressed, firstPress] = KbQueueCheck(DEVICE);            if pressed                firstPress(find(firstPress==0))=NaN; %get rid of 0s                [secs, keyCode]=min(firstPress); %KbName(keyCode) will convert KeyID to keyname                if keyCode == trigger_key                    recorded = true;                    break;                end            end        else % if haven't set a time, just wait until the trigger is pressed            %[keyIsDown,secs,keyCode] = KbCheck(DEVICE);            %             if (keyIsDown)            [pressed, firstPress] = KbQueueCheck(DEVICE);            if pressed                firstPress(find(firstPress==0))=NaN; %get rid of 0s                [secs, keyCode]=min(firstPress); %KbName(keyCode) will convert KeyID to keyname                if keyCode == trigger_key                    recorded = true;                    break;                end            end        end    endendvarargout{1} = secs;varargout{2} = recorded;end% if(~recorded)%     secs = GetSecs;% end% if nargin > 1 && strcmp(varargin{nargin-1}, 'debug')%     n_dsecs = 2000;%     dsecs = zeros(n_dsecs,1);%     if nargin < 2 || nargin > 3%         error('Wrong Number of Arguments')%     elseif nargin == 3%         for i = 1:numberPulses%             index = 0;%             while (GetSecs<varargin{1})%                 WaitSecs(loop_delay);%                 index = index + 1;%                 [keyIsDown,secs,keyCode, delsecs] = KbCheck(DEVICE);%                 dsecs(index) = delsecs*1000;%                 if (~keyCode(trigger_key))%                     break;%                 end%             end%             while (GetSecs<varargin{1})%                 WaitSecs(loop_delay);%                 index = index + 1;%                 [keyIsDown,secs,keyCode, delsecs] = KbCheck(DEVICE);%                 dsecs(index) = delsecs*1000;%                 if (keyIsDown)%                     if (keyCode(trigger_key))%                         recorded = true;%                         break;%                     end%                 end%             end%         end%     else%         for i = 1:numberPulses%             index = 0;%             while (1)%                 WaitSecs(loop_delay);%                 index = index + 1;%                 [keyIsDown,secs,keyCode, delsecs] = KbCheck(DEVICE);%                 dsecs(index) = delsecs*1000;%                 if (~keyCode(trigger_key))%                     break;%                 end%             end%             while (1)%                 WaitSecs(loop_delay);%                 index = index + 1;%                 [keyIsDown,secs,keyCode, delsecs] = KbCheck(DEVICE);%                 dsecs(index) = delsecs*1000;%                 if (keyIsDown)%                     if (keyCode(trigger_key))%                         recorded = true;%                         break;%                     end%                 end%             end%         end%     end%     varargout{1} = secs;%     varargout{2} = recorded;%     varargout{3} = dsecs;% else%     if nargin < 1 || nargin > 2%         error('Wrong Number of Arguments')%     elseif nargin == 2%         for i = 1:numberPulses%             while (GetSecs<varargin{1})%                 WaitSecs(loop_delay);%                 [keyIsDown,secs,keyCode] = KbCheck(DEVICE);%                 if (~keyCode(trigger_key))%                     break;%                 end%             end%             while (GetSecs<varargin{1})%                 WaitSecs(loop_delay);%                 [keyIsDown,secs,keyCode] = KbCheck(DEVICE);%                 if (keyIsDown)%                     if (keyCode(trigger_key))%                         recorded = true;%                         break;%                     end%                 end%             end%         end%     else%         for i = 1:numberPulses%             while (1)%                 WaitSecs(loop_delay);%                 [keyIsDown,secs,keyCode] = KbCheck(DEVICE);%                 if (~keyCode(trigger_key))%                     break;%                 end%             end%             while (1)%                 WaitSecs(loop_delay);%                 [keyIsDown,secs,keyCode] = KbCheck(DEVICE);%                 if (keyIsDown)%                     if (keyCode(trigger_key))%                         recorded = true;%                         break;%                     end%                 end%             end%         end%     end%     varargout{1} = secs;%     varargout{2} = recorded;% end